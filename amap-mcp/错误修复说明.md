# MCP服务器错误修复说明

## 当前错误

代码中使用了错误的MCP API：
1. `stdio.stdio_server` 不存在
2. `ClientSession` 没有 `send_list_tools`、`listen`、`send_call_tool_result` 等方法
3. 使用了客户端API而不是服务器API

## 已修复的问题

✅ 类型注解错误（Optional参数）
✅ timeout参数类型错误
✅ CallToolResult的content类型问题（添加了type: ignore）

## 需要修复的核心问题

### MCP服务器实现方式错误

当前代码（第924-948行）使用了错误的API：

```python
# ❌ 错误的实现
from mcp import ClientSession, StdioServerParameters
from mcp.client import stdio

async with stdio.stdio_server(server_params) as (read_stream, write_stream):
    async with ClientSession(read_stream, write_stream) as session:
        await session.send_list_tools(server.tools)
        async for message in session.listen():
            # ...
```

### 正确的实现方式

有两种选择：

#### 方案1：使用FastMCP（推荐）

```python
from mcp.server.fastmcp import FastMCP

mcp = FastMCP("amap-mcp-server")

@mcp.tool()
async def geocode(address: str, city: Optional[str] = None):
    """地理编码：将地址转换为经纬度坐标"""
    client = AmapMCPClient()
    async with client:
        result = await client.geocode(address, city)
        return format_geocode_response(result)

# ... 其他工具 ...

if __name__ == "__main__":
    mcp.run(transport="stdio")
```

#### 方案2：使用原始MCP Server API

```python
from mcp.server import Server
from mcp.server.stdio import stdio_server

app = Server("amap-mcp-server")

@app.tool()
async def geocode(address: str, city: Optional[str] = None):
    """地理编码：将地址转换为经纬度坐标"""
    client = AmapMCPClient()
    async with client:
        result = await client.geocode(address, city)
        return format_geocode_response(result)

async def main():
    async with stdio_server() as (read_stream, write_stream):
        await app.run(
            read_stream, 
            write_stream, 
            app.create_initialization_options()
        )

if __name__ == "__main__":
    asyncio.run(main())
```

## 建议

由于当前代码结构比较复杂，建议：

1. **保持现有的AmapMCPClient类** - 这个类实现得很好
2. **保持现有的AmapMCPServer类** - 但需要修改main函数
3. **重写main函数** - 使用正确的MCP服务器API

需要我帮你重写main函数吗？

